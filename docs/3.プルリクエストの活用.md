# プルリクエスト

ここまでで、様々なContextを使ってGitHub ActionsとClaude Codeを活用したアプリケーションの開発ができるようになりました。

しかし、AIエージェントによる開発には次のような課題があります。

1. AIが書いたコードの正しさを判断するのが難しい
2. AIが開発したコードの品質を担保したい
3. 自分たちのコーディング規約に違反するコードは反映できないようにしたい

今日は、これらの問題に対するアプローチを学びます。

## 1. AIが書いたコードの正しさを判断するためにAIを使う

これまでのPRでお気づきかもしれませんが現在のrepositoryの設定では、Pull Request(PR)が作成されるとその変更内容をPR-Agentというソフトウェアでチェックするようになっています。

![Copy raw file](/docs/images/3.1.png)

まずはPRを作成して、PR-Agentが動作している状態を作成しましょう。

題材はなんでも良いですが今回は完成させることは重要ではないとして、「テトリス」を作成させてみましょう。

GitHubのIssueに`@claude`をつけて、次の指示を入力して作成してください。

ここで作成するPRは後で使うので、mergeせずに残しておいてください。

```
# Role
あなたは熟練のゲーム開発エンジニアです。

# Task
キーボードで操作可能なテトリスを /tetris でアクセスできるページに作成してください。

# Requirements
1. 画面構成:
   - 10x20のメインフィールド
   - 次のブロック（Next）を表示するサイドパネル
   - 現在のスコア表示
2. 操作方法:
   - 矢印キー（左/右）：移動
   - 矢印キー（下）：ソフトドロップ
   - 矢印キー（上）：回転
   - スペースキー：ハードドロップ
3. ロジック:
   - 7種類のテトリミノ（I, J, L, O, S, T, Z）を標準的な色で実装
   - ラインが揃ったら消去し、上のブロックを詰める
   - ゲームオーバー判定（一番上まで積み上がったら停止）
4. デザイン:
   - モダンで視認性の高いダークテーマのUI
   - ブロックにわずかな境界線を引き、1マスずつ判別できるようにする
```

![Copy raw file](/docs/images/3.2.png)

Claude Codeの実装が終わったら、PRを作成しましょう。

しばらく待つと、PRにPR-Agentが次のように指摘を加えているはずです。

※指摘の内容は人によって異なります。

![Copy raw file](/docs/images/3.3.png)

この例では、確実に対応しないといけない問題が報告されています。

AIが問題となる箇所とその理由を示しているならば、その修正をAIにやらせるのは非常に合理的です。

PR-Agentの良いところは、問題の指摘箇所を示して会話可能な形式でフィードバックをもらえるので、人間にとって問題のコードブロックが認識しやくす、そのcontextをAIに与えやすい点です。

指摘をAIに直してもらう時は、`Reply`欄に`@claude`をつけて指示を与えるだけで済み、余計な説明は不要です。

![Copy raw file](/docs/images/3.4.png)

![Copy raw file](/docs/images/3.5.png)

Claude Code Actionは、自分がどの場面で`@claude`をつけられているのかを認識し、その状況に応じた振る舞いをしてくれます。

修正を指示すると、次のようにClaude Codeが会話に参加してくれます。

![Copy raw file](/docs/images/3.6.png)

修正が完了したら、修正commitが1つ追加されています。

![Copy raw file](/docs/images/3.7.png)

他にも修正すべき指摘があれば、`@claude`をつけて修正させてみましょう。

これでmergeしても良いのですが、最後にもう1度全体のレビューをさせることをおすすめします。

PRページの最下部に`Add a comment`という入力欄があるので、そこに`@claude コード全体をレビューして`と指示をしましょう。

![Copy raw file](/docs/images/3.8.png)

この時、PR-Agentは可能な限りClaude以外のモデルを利用すると良いです。

様々な種類のLLMからレビューさせることで、異なる視点からの指摘を得られやすいです。

私は普段PR-AgentにGeminiを利用しています。

全体をレビューさせた結果、異なる問題点を発見してくれる場合がありますので、それに対してまた`@claude`をつけて修正を依頼します。

このPRのcomment履歴は全てcontextとしてClaude Codeに渡されていることを覚えておきましょう。

PR-Agentの指摘はReply可能な形式なのに対して、Claude Codeの指摘はReplyではなく通常のcommentとして追加されます。

---

### コラム パブリッククラウドをClaude CodeやPR-Agentから利用する

このrepositoryではAnthropicのAPIキーを利用していますが、Google Cloud, AWS, Azureをお使いであれば、それらが提供するLLMを利用できます。

Google CloudとAzureではなんと名前が同じWorkload Identity Federationという機能を活用でき、AWSにも同様の仕組みが存在するため、これらを活用することでLLMを利用しやすくなるはずです。

設定ファイルの書き方のドキュメントをリンクとして貼っておきます。

[Claude Code](https://code.claude.com/docs/en/third-party-integrations)

[PR-Agent](https://qodo-merge-docs.qodo.ai/usage-guide/changing_a_model/)

これらを参考に、 [.pr_agent.toml](/.pr_agent.toml) や [claude.yaml](/.github/workflows/claude.yaml)を修正してみてください。

---

## 2. AIが書いたコードの品質を担保したい

コードの品質といっても様々な観点があると思いますが、ここではGitHub Pagesにデプロイできないコードが生まれないように「ビルドに通ること」の1点のみを担保します。

ここでもGitHub Actionsが活躍します。

GitHubでは、PRをmergeできるかどうかを判断して制御する仕組みがあり、その判断にGitHub Actionsの結果を利用できます。

みなさんにforkしてもらったrepositoryにはそのチェックを行うGitHub Actionsが定義されていない状態なので、この手順を真似するかどうかは任意とし、お話だけ聞いてくだされば十分です。

真似をしてみる方は、私のrepositoryに[check.yaml](https://github.com/YukiTominaga/ai-development-workflow/blob/main/.github/workflows/check.yaml) というファイルを用意してあるので、このファイルの内容をご自身のrepositoryの`.github/`ディレクトリに作成します。

GitHubで`.github/`ディレクトリにアクセスすると、右端に**Add file** > **Create new file**というメニューがあるので、そこから作成します。

![Copy raw file](/docs/images/3.9.png)

ファイル名は`check.yaml`とし、内容をコピペしたら**Commit changes**でファイルを作成できます。Commit時のメッセージはなんでも良いです。

![Copy raw file](/docs/images/3.10.png)

続いて、PRの宛先である`main`ブランチにPRのガードレールを設定します。

repositoryの**Settings > Rules > Rulesets**から**New branch ruleset**をクリックします。

![Copy raw file](/docs/images/3.11.png)

次の表に従って各項目を設定します。その他の項目はデフォルトのままで構いません。

| 設定項目         | 設定内容                   |
|------------------|--------------------------|
| Ruleset Name         | `main`         |
| Enforcement status     | `Active`                 |
| Target branches     | Add targetから、`Include default branch`              |
| Require status checks to pass | ✅️|
| Add checks   | `Build Check`と入力し出てきた行に✅️           |
| Any source       | `GitHub Actions`に変更   |

Require status checks to passの設定イメージを貼っておきます。

![Copy raw file](/docs/images/3.12.png)

これで、アプリケーションのビルドに失敗するPRは`main`ブランチにmergeできなくなりました。

このビルドチェックの処理はPRの作成、PRをcloseした後のopen、draft状態のPRからdraftを外す、PRのブランチに新しいcommitが作成されるの4つのトリガーで実行されます。

テトリスの実装で作ったPRには、ページの一番下にPRをcloseするボタンがあります。

![Copy raw file](/docs/images/3.13.png)

このcloseをクリックすると、**Reopen pull request**というボタンが表示されるようになるので、そのボタンを押してPRをReopenしましょう。

すると、`Build Check`というcheckが実行されるようになっています。(PR-Agentもreopenで動くように設定していたのでここで一緒に実行されています)

![Copy raw file](/docs/images/3.14.png)
